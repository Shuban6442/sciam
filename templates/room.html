<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Session {{ room_id }}</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; padding: 16px; }
    header { padding: 8px 0; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .pill { padding: 4px 8px; border-radius: 999px; border: 1px solid #ccc; }
    #shareLink { width: 360px; max-width: 100%; padding: 6px; }
    #main { display: grid; grid-template-rows: 1fr 200px; height: 80vh; gap: 8px; }
    #editor { width: 100%; height: 100%; min-height: 300px; border: 1px solid #eee; background: #1e1e1e; }
    #output { border-top: 1px solid #eee; display: grid; grid-template-columns: 1fr; gap: 8px; }
    #console { padding: 8px; font-family: Consolas, monospace; font-size: 13px; white-space: pre-wrap; overflow: auto; border: 1px solid #eee; height: 100%; }
  </style>

  <!-- Monaco Editor -->
  <script>var require = { paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } };</script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js"></script>
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <h2>Session: {{ room_id }}</h2>
  <header>
    <input id="shareLink" type="text" value="{{ request.url }}" readonly>
    <button onclick="navigator.clipboard.writeText(document.getElementById('shareLink').value)">Copy Link</button>
  </header>

  <div id="main">
    <div id="editor"></div>
    <div id="output">
      <div id="console"></div>
    </div>
  </div>

  <script>
    const ROOM_ID = "{{ room_id }}";
    let DISPLAY_NAME = "";
    let socket;
    let monacoEditor = null;
    let pendingIncomingCode = null;  // buffer until Monaco ready
    let localEdit = false;

    // Ask for display name
    (function ensureName(){
      const name = prompt("Enter your display name") || "Participant";
      DISPLAY_NAME = name.trim();
    })();

    // Initialize socket
    function initSocket(){
      if (socket) return;
      socket = io({ transports: ['websocket', 'polling'] });

      // Handle incoming code updates
      socket.on("update_code", (data) => {
        const incoming = data && data.code || "";
        if (!monacoEditor) {
          pendingIncomingCode = incoming;
          return;
        }
        if (localEdit) return; // ignore own edit echoes
        if (monacoEditor.getValue() !== incoming) {
          const pos = monacoEditor.getPosition();
          monacoEditor.setValue(incoming);
          if (pos) monacoEditor.setPosition(pos);
        }
      });

      // Join room after connecting
      socket.on("connect", () => {
        console.log("Connected to server, joining room:", ROOM_ID);
        socket.emit("join_room", { room: ROOM_ID, name: DISPLAY_NAME });
        socket.emit("request_code", { room: ROOM_ID }); // ask for latest code
      });

      socket.on("connect_error", (err) => {
        console.error("Socket connection error:", err);
      });
    }
    initSocket();

    // Load Monaco Editor
    require(["vs/editor/editor.main"], function () {
      monacoEditor = monaco.editor.create(document.getElementById("editor"), {
        value: "",
        language: "javascript",
        theme: "vs-dark",
        automaticLayout: true,
        minimap: { enabled: false }
      });

      // Apply any buffered code
      if (pendingIncomingCode !== null) {
        monacoEditor.setValue(pendingIncomingCode);
        pendingIncomingCode = null;
      }

      // Everyone can edit
      monacoEditor.updateOptions({ readOnly: false });

      // Emit changes to server
      monacoEditor.onDidChangeModelContent(() => {
        localEdit = true;
        const code = monacoEditor.getValue();
        if (socket && socket.connected) {
          socket.emit("code_update", { room: ROOM_ID, code });
        }
        setTimeout(() => { localEdit = false; }, 0);
      });
    });
  </script>
</body>
</html>
